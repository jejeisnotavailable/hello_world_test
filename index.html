<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片转拼豆风格生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            flex: 1;
            min-width: 300px;
        }
        
        .panel-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            color: #6a11cb;
        }
        
        .upload-area {
            border: 3px dashed #6a11cb;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background-color: #f9f9ff;
        }
        
        .upload-area:hover {
            background-color: #f0f0ff;
            border-color: #2575fc;
        }
        
        .upload-area i {
            font-size: 4rem;
            color: #6a11cb;
            margin-bottom: 15px;
        }
        
        .upload-area p {
            margin-bottom: 10px;
            color: #555;
        }
        
        .upload-area span {
            color: #6a11cb;
            font-weight: bold;
        }
        
        #imageInput {
            display: none;
        }
        
        .preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .image-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f9f9f9;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-preview p {
            color: #888;
            font-style: italic;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #444;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 10px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #6a11cb;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .range-value {
            font-weight: bold;
            color: #6a11cb;
            min-width: 40px;
            text-align: center;
        }
        
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .color-item {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.2s;
        }
        
        .color-item:hover {
            transform: scale(1.1);
        }
        
        .color-item.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #6a11cb;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 160px;
        }
        
        .primary-btn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        
        .primary-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(106, 17, 203, 0.3);
        }
        
        .secondary-btn {
            background-color: #f1f3f9;
            color: #444;
        }
        
        .secondary-btn:hover {
            background-color: #e4e8f5;
        }
        
        .result-container {
            width: 100%;
            overflow: auto;
            margin-top: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            background-color: #f9f9f9;
            padding: 20px;
            text-align: center;
        }
        
        #resultCanvas {
            max-width: 100%;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .instructions {
            background-color: #fff9e6;
            border-left: 5px solid #ffcc00;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .instructions h3 {
            color: #d4a600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: #777;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 1100px) {
            .container {
                flex-direction: column;
            }
            
            .panel {
                width: 100%;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6a11cb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-th-large"></i> 图片转拼豆风格生成器</h1>
        <p class="subtitle">上传图片，自动转换为像素化的拼豆风格图像，适合制作实际的拼豆艺术作品</p>
    </header>
    
    <div class="container">
        <div class="panel">
            <h2 class="panel-title"><i class="fas fa-upload"></i> 上传图片</h2>
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>点击此处上传图片，或拖放图片到此处</p>
                <p>支持 JPG、PNG 格式，最大 5MB</p>
                <span>选择图片</span>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            
            <div class="preview-container">
                <div class="image-preview" id="imagePreview">
                    <p>图片预览区域</p>
                </div>
                
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>正在生成拼豆图像...</p>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2 class="panel-title"><i class="fas fa-sliders-h"></i> 调整设置</h2>
            
            <div class="controls">
                <div class="control-group">
                    <label for="pixelSize"><i class="fas fa-th"></i> 像素大小</label>
                    <div class="range-container">
                        <input type="range" id="pixelSize" min="5" max="50" value="15">
                        <span class="range-value" id="pixelSizeValue">15</span>
                    </div>
                    <p>控制拼豆颗粒的大小，值越大颗粒越少</p>
                </div>
                
                <div class="control-group">
                    <label for="colorCount"><i class="fas fa-palette"></i> 颜色数量</label>
                    <div class="range-container">
                        <input type="range" id="colorCount" min="2" max="20" value="10">
                        <span class="range-value" id="colorCountValue">10</span>
                    </div>
                    <p>限制拼豆图像中的颜色数量</p>
                </div>
                
                <div class="control-group">
                    <label><i class="fas fa-fill-drip"></i> 颜色调色板</label>
                    <p>点击选择要使用的颜色（可多选）</p>
                    <div class="color-palette" id="colorPalette">
                        <!-- 颜色块将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="primary-btn" id="generateBtn">
                        <i class="fas fa-magic"></i> 生成拼豆图像
                    </button>
                    <button class="secondary-btn" id="resetBtn">
                        <i class="fas fa-redo"></i> 重置设置
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="panel">
        <h2 class="panel-title"><i class="fas fa-image"></i> 拼豆结果</h2>
        
        <div class="buttons">
            <button class="primary-btn" id="downloadBtn">
                <i class="fas fa-download"></i> 下载拼豆图像
            </button>
            <button class="secondary-btn" id="toggleGridBtn">
                <i class="fas fa-border-all"></i> 切换网格显示
            </button>
        </div>
        
        <div class="result-container">
            <canvas id="resultCanvas"></canvas>
            <canvas id="gridCanvas" class="grid-overlay"></canvas>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-lightbulb"></i> 使用说明</h3>
            <ol>
                <li>上传您想要转换为拼豆风格的图片</li>
                <li>调整像素大小和颜色数量设置</li>
                <li>选择要使用的颜色（拼豆常见颜色）</li>
                <li>点击"生成拼豆图像"按钮创建效果</li>
                <li>使用"切换网格显示"查看拼豆网格</li>
                <li>下载图像用于打印或制作拼豆艺术品</li>
            </ol>
        </div>
    </div>
    
    <footer>
        <p>© 2023 拼豆图片生成器 | 本工具使用HTML5 Canvas实现，图片处理在浏览器本地完成</p>
    </footer>

    <script>
        // DOM元素
        const imageInput = document.getElementById('imageInput');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const resultCanvas = document.getElementById('resultCanvas');
        const gridCanvas = document.getElementById('gridCanvas');
        const generateBtn = document.getElementById('generateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const toggleGridBtn = document.getElementById('toggleGridBtn');
        const pixelSizeSlider = document.getElementById('pixelSize');
        const pixelSizeValue = document.getElementById('pixelSizeValue');
        const colorCountSlider = document.getElementById('colorCount');
        const colorCountValue = document.getElementById('colorCountValue');
        const colorPalette = document.getElementById('colorPalette');
        const loading = document.getElementById('loading');
        
        // 全局变量
        let originalImage = null;
        let beadImage = null;
        let showGrid = false;
        let selectedColors = new Set();
        
        // 预定义拼豆常用颜色
        const beadColors = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
            '#FFA500', '#800080', '#008080', '#FFC0CB', '#A52A2A', '#FFFFFF',
            '#000000', '#808080', '#C0C0C0', '#8B4513', '#FFD700', '#4B0082',
            '#32CD32', '#1E90FF', '#FF4500', '#DA70D6', '#20B2AA', '#FF6347'
        ];
        
        // 初始化
        function init() {
            // 初始化颜色调色板
            renderColorPalette();
            
            // 默认选择前10个颜色
            for (let i = 0; i < 10; i++) {
                selectedColors.add(beadColors[i]);
            }
            updateColorSelection();
            
            // 设置事件监听器
            uploadArea.addEventListener('click', () => imageInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            imageInput.addEventListener('change', handleImageUpload);
            
            pixelSizeSlider.addEventListener('input', updatePixelSizeValue);
            colorCountSlider.addEventListener('input', updateColorCountValue);
            
            generateBtn.addEventListener('click', generateBeadImage);
            resetBtn.addEventListener('click', resetSettings);
            downloadBtn.addEventListener('click', downloadImage);
            toggleGridBtn.addEventListener('click', toggleGrid);
            
            // 初始化滑块值显示
            updatePixelSizeValue();
            updateColorCountValue();
        }
        
        // 渲染颜色调色板
        function renderColorPalette() {
            colorPalette.innerHTML = '';
            
            beadColors.forEach(color => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.style.backgroundColor = color;
                colorItem.dataset.color = color;
                colorItem.title = color;
                
                colorItem.addEventListener('click', () => {
                    if (selectedColors.has(color)) {
                        selectedColors.delete(color);
                    } else {
                        selectedColors.add(color);
                    }
                    updateColorSelection();
                });
                
                colorPalette.appendChild(colorItem);
            });
        }
        
        // 更新颜色选择状态
        function updateColorSelection() {
            const colorItems = document.querySelectorAll('.color-item');
            colorItems.forEach(item => {
                const color = item.dataset.color;
                if (selectedColors.has(color)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // 确保至少选择一种颜色
            if (selectedColors.size === 0) {
                selectedColors.add(beadColors[0]);
                updateColorSelection();
            }
        }
        
        // 更新像素大小值显示
        function updatePixelSizeValue() {
            pixelSizeValue.textContent = pixelSizeSlider.value;
        }
        
        // 更新颜色数量值显示
        function updateColorCountValue() {
            colorCountValue.textContent = colorCountSlider.value;
        }
        
        // 处理拖放
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#2575fc';
            uploadArea.style.backgroundColor = '#f0f0ff';
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#6a11cb';
            uploadArea.style.backgroundColor = '#f9f9ff';
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                loadImage(files[0]);
            }
        }
        
        // 处理图片上传
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        }
        
        // 加载图片
        function loadImage(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    displayPreviewImage(img);
                };
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        // 显示预览图片
        function displayPreviewImage(img) {
            imagePreview.innerHTML = '';
            const imgElement = document.createElement('img');
            imgElement.src = img.src;
            imagePreview.appendChild(imgElement);
        }
        
        // 生成拼豆图像
        function generateBeadImage() {
            if (!originalImage) {
                alert('请先上传一张图片');
                return;
            }
            
            loading.style.display = 'block';
            
            // 使用setTimeout让UI有机会更新加载状态
            setTimeout(() => {
                try {
                    const pixelSize = parseInt(pixelSizeSlider.value);
                    const colorCount = parseInt(colorCountSlider.value);
                    
                    // 创建临时canvas处理图像
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // 计算适合的尺寸
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let width = originalImage.width;
                    let height = originalImage.height;
                    
                    // 保持宽高比
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = (maxHeight / height) * width;
                        height = maxHeight;
                    }
                    
                    // 设置canvas尺寸
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    
                    // 绘制原始图像
                    tempCtx.drawImage(originalImage, 0, 0, width, height);
                    
                    // 获取图像数据
                    let imageData = tempCtx.getImageData(0, 0, width, height);
                    
                    // 应用像素化
                    imageData = pixelate(imageData, pixelSize);
                    
                    // 应用颜色简化
                    const colors = Array.from(selectedColors);
                    imageData = reduceColors(imageData, colors, colorCount);
                    
                    // 绘制结果到显示canvas
                    resultCanvas.width = width;
                    resultCanvas.height = height;
                    const resultCtx = resultCanvas.getContext('2d');
                    resultCtx.putImageData(imageData, 0, 0);
                    
                    // 保存结果图像
                    beadImage = resultCanvas.toDataURL('image/png');
                    
                    // 更新网格canvas
                    updateGridCanvas(pixelSize);
                    
                    loading.style.display = 'none';
                    
                } catch (error) {
                    console.error('生成拼豆图像时出错:', error);
                    alert('生成图像时出错，请重试');
                    loading.style.display = 'none';
                }
            }, 100);
        }
        
        // 像素化处理
        function pixelate(imageData, pixelSize) {
            const { width, height, data } = imageData;
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            
            // 绘制原始图像
            tempCtx.putImageData(imageData, 0, 0);
            
            // 缩小图像实现像素化
            const smallCanvas = document.createElement('canvas');
            const smallCtx = smallCanvas.getContext('2d');
            const smallWidth = Math.floor(width / pixelSize);
            const smallHeight = Math.floor(height / pixelSize);
            smallCanvas.width = smallWidth;
            smallCanvas.height = smallHeight;
            
            // 绘制缩小版
            smallCtx.drawImage(tempCanvas, 0, 0, smallWidth, smallHeight);
            
            // 放大回原始尺寸
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.drawImage(smallCanvas, 0, 0, smallWidth, smallHeight, 0, 0, width, height);
            
            return tempCtx.getImageData(0, 0, width, height);
        }
        
        // 颜色简化
        function reduceColors(imageData, availableColors, maxColors) {
            const { width, height, data } = imageData;
            const resultData = new ImageData(width, height);
            
            // 限制颜色数量
            const colorsToUse = availableColors.slice(0, Math.min(maxColors, availableColors.length));
            
            // 将十六进制颜色转换为RGB
            const colorRGBs = colorsToUse.map(hex => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return { r, g, b };
            });
            
            // 处理每个像素
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const a = data[i + 3];
                
                // 找到最接近的颜色
                let closestColor = colorRGBs[0];
                let minDistance = colorDistance(r, g, b, closestColor.r, closestColor.g, closestColor.b);
                
                for (let j = 1; j < colorRGBs.length; j++) {
                    const color = colorRGBs[j];
                    const distance = colorDistance(r, g, b, color.r, color.g, color.b);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestColor = color;
                    }
                }
                
                // 设置结果像素
                resultData.data[i] = closestColor.r;
                resultData.data[i + 1] = closestColor.g;
                resultData.data[i + 2] = closestColor.b;
                resultData.data[i + 3] = a;
            }
            
            return resultData;
        }
        
        // 计算颜色距离
        function colorDistance(r1, g1, b1, r2, g2, b2) {
            return Math.sqrt(
                Math.pow(r1 - r2, 2) + 
                Math.pow(g1 - g2, 2) + 
                Math.pow(b1 - b2, 2)
            );
        }
        
        // 更新网格canvas
        function updateGridCanvas(pixelSize) {
            if (!showGrid) return;
            
            gridCanvas.width = resultCanvas.width;
            gridCanvas.height = resultCanvas.height;
            const gridCtx = gridCanvas.getContext('2d');
            
            // 绘制网格
            gridCtx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
            gridCtx.lineWidth = 1;
            
            // 垂直线
            for (let x = 0; x <= gridCanvas.width; x += pixelSize) {
                gridCtx.beginPath();
                gridCtx.moveTo(x, 0);
                gridCtx.lineTo(x, gridCanvas.height);
                gridCtx.stroke();
            }
            
            // 水平线
            for (let y = 0; y <= gridCanvas.height; y += pixelSize) {
                gridCtx.beginPath();
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(gridCanvas.width, y);
                gridCtx.stroke();
            }
        }
        
        // 切换网格显示
        function toggleGrid() {
            showGrid = !showGrid;
            
            if (showGrid) {
                gridCanvas.style.display = 'block';
                toggleGridBtn.innerHTML = '<i class="fas fa-border-all"></i> 隐藏网格';
                const pixelSize = parseInt(pixelSizeSlider.value);
                updateGridCanvas(pixelSize);
            } else {
                gridCanvas.style.display = 'none';
                toggleGridBtn.innerHTML = '<i class="fas fa-border-all"></i> 显示网格';
            }
        }
        
        // 重置设置
        function resetSettings() {
            pixelSizeSlider.value = 15;
            colorCountSlider.value = 10;
            
            // 重置颜色选择
            selectedColors.clear();
            for (let i = 0; i < 10; i++) {
                selectedColors.add(beadColors[i]);
            }
            
            updatePixelSizeValue();
            updateColorCountValue();
            updateColorSelection();
            
            // 重新生成图像
            if (originalImage) {
                generateBeadImage();
            }
        }
        
        // 下载图像
        function downloadImage() {
            if (!beadImage) {
                alert('请先生成拼豆图像');
                return;
            }
            
            const link = document.createElement('a');
            link.download = '拼豆图像.png';
            link.href = beadImage;
            link.click();
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
